From b66d11e29d25954e25f2df05b4488895fcf351dc Mon Sep 17 00:00:00 2001
From: Yonggang Luo <luoyonggang@gmail.com>
Date: Mon, 29 Dec 2025 20:32:45 +0800
Subject: [PATCH 20/21] use and generate to msys2 dlls

---
 gcc/config/i386/cygwin-w64.h | 8 ++++----
 gcc/config/i386/cygwin.h     | 9 +++++----
 gcc/config/i386/t-cygwin-w64 | 3 +++
 libgcc/config/i386/t-cygwin  | 4 ++--
 4 files changed, 14 insertions(+), 10 deletions(-)

diff --git a/gcc/config/i386/cygwin-w64.h b/gcc/config/i386/cygwin-w64.h
index f9c4e207c36..200971890f4 100644
--- a/gcc/config/i386/cygwin-w64.h
+++ b/gcc/config/i386/cygwin-w64.h
@@ -45,8 +45,8 @@ along with GCC; see the file COPYING3.  If not see
 
 #undef SUB_LINK_ENTRY32
 #undef SUB_LINK_ENTRY64
-#define SUB_LINK_ENTRY32 "-e __cygwin_dll_entry@12"
-#define SUB_LINK_ENTRY64 "-e _cygwin_dll_entry"
+#define SUB_LINK_ENTRY32 "-e __msys_dll_entry@12"
+#define SUB_LINK_ENTRY64 "-e _msys_dll_entry"
 
 #undef SUB_LINK_SPEC
 #undef SUB_LINK_ENTRY
@@ -66,7 +66,7 @@ along with GCC; see the file COPYING3.  If not see
   %{static:-Bstatic} %{!static:-Bdynamic} \
   %{shared|mdll: " SUB_LINK_ENTRY " --enable-auto-image-base} \
   %(shared_libgcc_undefs) \
-  --dll-search-prefix=cyg \
+  --dll-search-prefix=msys- \
   %{rdynamic: --export-all-symbols} \
   %{!shared: %{!mdll: %{" SPEC_32 ":--large-address-aware} --tsaware}}"
 
@@ -82,4 +82,4 @@ along with GCC; see the file COPYING3.  If not see
 #define PTRDIFF_TYPE (TARGET_64BIT ? "long int" : "int")
 
 #undef LIBGCC_SONAME
-#define LIBGCC_SONAME "cyggcc_s-seh-1.dll"
+#define LIBGCC_SONAME "msys-gcc_s-seh-1.dll"
diff --git a/gcc/config/i386/cygwin.h b/gcc/config/i386/cygwin.h
index c3267a12f8f..275aeb079eb 100644
--- a/gcc/config/i386/cygwin.h
+++ b/gcc/config/i386/cygwin.h
@@ -22,6 +22,7 @@ along with GCC; see the file COPYING3.  If not see
   do								\
     {								\
       builtin_define ("__CYGWIN__");				\
+      builtin_define ("__MSYS__");				\
       if (!TARGET_64BIT)					\
 	builtin_define ("__CYGWIN32__");			\
       builtin_define_std ("unix");				\
@@ -85,7 +86,7 @@ along with GCC; see the file COPYING3.  If not see
   %{pthread: } \
   -lintl \
   -liconv \
-  -lcygwin \
+  -lmsys-2.0 \
   %{mwindows:-lgdi32 -lcomdlg32} \
   %{fvtable-verify=preinit:-lvtv -lpsapi; \
     fvtable-verify=std:-lvtv -lpsapi} \
@@ -130,8 +131,8 @@ along with GCC; see the file COPYING3.  If not see
   %{shared: %{mdll: %eshared and mdll are not compatible}} \
   %{shared: --shared} %{mdll:--dll} \
   %{static:-Bstatic} %{!static:-Bdynamic} \
-  %{shared|mdll: --enable-auto-image-base -e __cygwin_dll_entry@12} \
-  --dll-search-prefix=cyg \
+  %{shared|mdll: --enable-auto-image-base -e __msys_dll_entry@12} \
+  --dll-search-prefix=msys- \
   %{rdynamic: --export-all-symbols} \
   %{!shared: %{!mdll: --large-address-aware --tsaware}}"
 
@@ -153,7 +154,7 @@ along with GCC; see the file COPYING3.  If not see
 #else
 #define LIBGCC_EH_EXTN "-sjlj"
 #endif
-#define LIBGCC_SONAME "cyggcc_s" LIBGCC_EH_EXTN "-1.dll"
+#define LIBGCC_SONAME "msys-gcc_s" LIBGCC_EH_EXTN "-1.dll"
 
 /* Make stack executable to avoid DEP problems with trampolines.  */
 #define HAVE_ENABLE_EXECUTE_STACK
diff --git a/gcc/config/i386/t-cygwin-w64 b/gcc/config/i386/t-cygwin-w64
index e69de29bb2d..9116267ebc0 100644
--- a/gcc/config/i386/t-cygwin-w64
+++ b/gcc/config/i386/t-cygwin-w64
@@ -0,0 +1,3 @@
+MULTILIB_OPTIONS = m64/m32
+MULTILIB_DIRNAMES = 64
+MULTILIB_OSDIRNAMES = ../lib ../lib32
\ No newline at end of file
diff --git a/libgcc/config/i386/t-cygwin b/libgcc/config/i386/t-cygwin
index d3f0884b323..15e7172f455 100644
--- a/libgcc/config/i386/t-cygwin
+++ b/libgcc/config/i386/t-cygwin
@@ -5,14 +5,14 @@ LIBGCC2_INCLUDES += -I$(srcdir)/../winsup/include \
 	-I$(srcdir)/../winsup/cygwin/include
 
 # Cygwin-specific parts of LIB_SPEC
-SHLIB_LC = -lintl -liconv -lcygwin -ladvapi32 -lshell32 -luser32 -lkernel32
+SHLIB_LC = -lintl -liconv -lmsys-2.0 -ladvapi32 -lshell32 -luser32 -lkernel32
 
 # We have already included one of the t-{dw2,sjlj}-eh fragments for EH_MODEL
 SHLIB_EH_EXTENSION = $(subst -dw2,,-$(EH_MODEL))
 
 # Cygwin uses different conventions than MinGW; override generic SHLIB_ def'ns here.
 SHLIB_IMPLIB = @shlib_base_name@$(SHLIB_EXT).a
-SHLIB_SONAME = cyggcc_s$(SHLIB_EH_EXTENSION)-$(SHLIB_SOVERSION)$(SHLIB_EXT)
+SHLIB_SONAME = msys-gcc_s$(SHLIB_EH_EXTENSION)-$(SHLIB_SOVERSION)$(SHLIB_EXT)
 # This must match the definitions of SHLIB_SONAME/SHLIB_SOVERSION and LIBGCC_SONAME.
 # We'd like to use SHLIB_SONAME here too, and we can, since
 # we don't rely on shlib_base_name substitution for it.
-- 
2.51.0.windows.1

